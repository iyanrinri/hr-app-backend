generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                BigInt    @id @default(autoincrement())
  email             String    @unique
  password          String
  role              Role      @default(EMPLOYEE)
  isDeleted         Boolean   @default(false)
  deletedAt         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  employee          Employee?
  processedPayrolls Payroll[]
  generatedPayslips Payslip[]

  @@map("users")
}

model Employee {
  id             BigInt          @id @default(autoincrement())
  userId         BigInt          @unique
  firstName      String
  lastName       String
  position       String
  department     String
  joinDate       DateTime
  managerId      BigInt?
  
  // Personal Information
  employeeNumber        String?   @unique
  dateOfBirth           DateTime?
  gender                Gender?
  maritalStatus         MaritalStatus?
  nationality           String?
  religion              String?
  bloodType             String?
  idNumber              String?   @unique
  taxNumber             String?
  
  // Contact Information
  phoneNumber           String?
  alternativePhone      String?
  address               String?
  city                  String?
  province              String?
  postalCode            String?
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelation String?
  
  // Bank Information
  bankName              String?
  bankAccountNumber     String?
  bankAccountName       String?
  
  // Employment Details
  employmentStatus      EmploymentStatus @default(PERMANENT)
  contractStartDate     DateTime?
  contractEndDate       DateTime?
  workLocation          String?
  
  // Profile Picture
  profilePicture        String?
  
  isDeleted      Boolean         @default(false)
  deletedAt      DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  attendanceLogs AttendanceLog[]
  attendances    Attendance[]
  user           User            @relation(fields: [userId], references: [id])
  leaveRequests  LeaveRequest[]
  payrolls       Payroll[]
  manager        Employee?       @relation("EmployeeHierarchy", fields: [managerId], references: [id])
  subordinates   Employee[]      @relation("EmployeeHierarchy")
  leaveBalances  LeaveBalance[]
  leaveApprovals LeaveApproval[] @relation("LeaveApprovals")
  salaries       Salary[]
  salaryHistories SalaryHistory[]
  overtimeRequests OvertimeRequest[]
  overtimeApprovals OvertimeApproval[] @relation("OvertimeApprovals")

  @@map("employees")
}

model Attendance {
  id                 BigInt           @id @default(autoincrement())
  employeeId         BigInt
  attendancePeriodId BigInt
  date               DateTime         @db.Date
  checkIn            DateTime?
  checkOut           DateTime?
  checkInLocation    String?
  checkOutLocation   String?
  workDuration       Int?
  status             AttendanceStatus @default(ABSENT)
  notes              String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  attendancePeriod   AttendancePeriod @relation(fields: [attendancePeriodId], references: [id])
  employee           Employee         @relation(fields: [employeeId], references: [id])
  overtimeRequests   OvertimeRequest[]

  @@unique([employeeId, date])
  @@map("attendances")
}

model AttendanceLog {
  id                 BigInt           @id @default(autoincrement())
  employeeId         BigInt
  attendancePeriodId BigInt
  type               AttendanceType
  timestamp          DateTime         @default(now())
  location           String
  ipAddress          String?
  userAgent          String?
  notes              String?
  createdAt          DateTime         @default(now())
  attendancePeriod   AttendancePeriod @relation(fields: [attendancePeriodId], references: [id])
  employee           Employee         @relation(fields: [employeeId], references: [id])

  @@map("attendance_logs")
}

model AttendancePeriod {
  id                         BigInt          @id @default(autoincrement())
  name                       String
  startDate                  DateTime        @db.Date
  endDate                    DateTime        @db.Date
  workingDaysPerWeek         Int             @default(5)
  workingHoursPerDay         Int             @default(8)
  workingStartTime           String          @default("09:00")
  workingEndTime             String          @default("17:00")
  allowSaturdayWork          Boolean         @default(false)
  allowSundayWork            Boolean         @default(false)
  lateToleranceMinutes       Int             @default(15)
  earlyLeaveToleranceMinutes Int             @default(15)
  isActive                   Boolean         @default(true)
  description                String?
  createdBy                  BigInt
  createdAt                  DateTime        @default(now())
  updatedAt                  DateTime        @updatedAt
  attendanceLogs             AttendanceLog[]
  attendances                Attendance[]
  holidays                   Holiday[]

  @@map("attendance_periods")
}

model Holiday {
  id                 BigInt            @id @default(autoincrement())
  attendancePeriodId BigInt?
  name               String
  date               DateTime          @db.Date
  isNational         Boolean           @default(false)
  isRecurring        Boolean           @default(false)
  description        String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  attendancePeriod   AttendancePeriod? @relation(fields: [attendancePeriodId], references: [id])

  @@map("holidays")
}

model Payroll {
  id                BigInt   @id @default(autoincrement())
  employeeId        BigInt
  periodStart       DateTime
  periodEnd         DateTime
  baseSalary        Decimal
  overtimePay       Decimal  @default(0)
  deductions        Decimal  @default(0)
  bonuses           Decimal  @default(0)
  grossSalary       Decimal
  netSalary         Decimal
  overtimeHours     Decimal  @default(0)
  regularHours      Decimal  @default(0)
  isPaid            Boolean  @default(false)
  processedAt       DateTime?
  processedBy       BigInt?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  employee          Employee @relation(fields: [employeeId], references: [id])
  processor         User?    @relation(fields: [processedBy], references: [id])
  payslip           Payslip?

  @@map("payrolls")
}

model Payslip {
  id                            BigInt   @id @default(autoincrement())
  payrollId                     BigInt   @unique
  
  // Income
  grossSalary                   Decimal
  overtimePay                   Decimal  @default(0)
  bonuses                       Decimal  @default(0)
  allowances                    Decimal  @default(0)
  
  // Deductions
  taxAmount                     Decimal  @default(0)  // PPh 21
  bpjsKesehatanEmployee         Decimal  @default(0)
  bpjsKesehatanCompany          Decimal  @default(0)
  bpjsKetenagakerjaanEmployee   Decimal  @default(0)  // JHT + JP + JKK + JKM
  bpjsKetenagakerjaanCompany    Decimal  @default(0)
  otherDeductions               Decimal  @default(0)
  
  // Take home
  takeHomePay                   Decimal
  
  // Tax calculation details (JSON)
  taxCalculationDetails         Json?    // PTKP, taxable income, brackets
  
  // Metadata
  generatedAt                   DateTime @default(now())
  generatedBy                   BigInt
  pdfUrl                        String?
  
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt
  
  payroll                       Payroll  @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  generator                     User     @relation(fields: [generatedBy], references: [id])
  deductions                    PayrollDeduction[]
  
  @@map("payslips")
}

model PayrollDeduction {
  id              BigInt   @id @default(autoincrement())
  payslipId       BigInt
  type            String   // TAX, BPJS_KESEHATAN, BPJS_TK, LOAN, OTHER
  description     String
  amount          Decimal
  createdAt       DateTime @default(now())
  
  payslip         Payslip  @relation(fields: [payslipId], references: [id], onDelete: Cascade)
  
  @@map("payroll_deductions")
}

model Setting {
  id          BigInt         @id @default(autoincrement())
  key         String         @unique
  value       String
  dataType    SettingDataType @default(STRING)
  category    SettingCategory @default(GENERAL)
  isPublic    Boolean        @default(false)
  description String?
  createdBy   BigInt
  updatedBy   BigInt
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("settings")
}

enum Role {
  SUPER
  HR
  MANAGER
  EMPLOYEE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum EmploymentStatus {
  PERMANENT
  CONTRACT
  PROBATION
  INTERN
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum AttendanceType {
  CLOCK_IN
  CLOCK_OUT
}

enum SettingDataType {
  STRING
  INTEGER
  DECIMAL
  BOOLEAN
  JSON
  EMAIL
  URL
  DATE
  DATETIME
  TIME
  PASSWORD
}

enum SettingCategory {
  GENERAL
  COMPANY
  ATTENDANCE
  LEAVE
  PAYROLL
  TAX_PPH21
  BPJS_KESEHATAN
  BPJS_KETENAGAKERJAAN
  NOTIFICATION
  SECURITY
  INTEGRATION
}

enum LeaveType {
  ANNUAL
  SICK
  MATERNITY
  PATERNITY
  HAJJ_UMRAH
  EMERGENCY
  COMPASSIONATE
  STUDY
  UNPAID
}

enum LeaveRequestStatus {
  PENDING
  MANAGER_APPROVED
  HR_APPROVED
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SalaryChangeType {
  INITIAL
  PROMOTION
  GRADE_ADJUSTMENT
  PERFORMANCE_INCREASE
  MARKET_ADJUSTMENT
  DEPARTMENT_TRANSFER
  POSITION_CHANGE
  ANNUAL_INCREMENT
}

enum OvertimeStatus {
  PENDING
  MANAGER_APPROVED
  HR_APPROVED
  APPROVED
  REJECTED
  CANCELLED
}

model LeavePeriod {
  id          BigInt    @id @default(autoincrement())
  name        String
  startDate   DateTime  @db.Date
  endDate     DateTime  @db.Date
  isActive    Boolean   @default(true)
  description String?
  createdBy   BigInt
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  leaveTypes  LeaveTypeConfig[]
  leaveBalances LeaveBalance[]
  leaveRequests LeaveRequest[]
  
  @@map("leave_periods")
}

model LeaveTypeConfig {
  id              BigInt      @id @default(autoincrement())
  leavePeriodId   BigInt
  type            LeaveType
  name            String
  description     String?
  defaultQuota    Int         @default(0)
  maxConsecutiveDays Int?
  advanceNoticeDays  Int      @default(0)
  isCarryForward  Boolean     @default(false)
  maxCarryForward Int?
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  leavePeriod     LeavePeriod @relation(fields: [leavePeriodId], references: [id])
  leaveBalances   LeaveBalance[]
  leaveRequests   LeaveRequest[]
  
  @@unique([leavePeriodId, type])
  @@map("leave_type_configs")
}

model LeaveBalance {
  id                BigInt          @id @default(autoincrement())
  employeeId        BigInt
  leavePeriodId     BigInt
  leaveTypeConfigId BigInt
  totalQuota        Int             @default(0)
  usedQuota         Int             @default(0)
  pendingQuota      Int             @default(0)
  carriedForward    Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  employee          Employee        @relation(fields: [employeeId], references: [id])
  leavePeriod       LeavePeriod     @relation(fields: [leavePeriodId], references: [id])
  leaveTypeConfig   LeaveTypeConfig @relation(fields: [leaveTypeConfigId], references: [id])
  
  @@unique([employeeId, leavePeriodId, leaveTypeConfigId])
  @@map("leave_balances")
}

model LeaveRequest {
  id                BigInt            @id @default(autoincrement())
  employeeId        BigInt
  leavePeriodId     BigInt
  leaveTypeConfigId BigInt
  startDate         DateTime          @db.Date
  endDate           DateTime          @db.Date
  totalDays         Int
  reason            String
  status            LeaveRequestStatus @default(PENDING)
  managerComments   String?
  hrComments        String?
  rejectionReason   String?
  emergencyContact  String?
  handoverNotes     String?
  submittedAt       DateTime          @default(now())
  managerApprovedAt DateTime?
  hrApprovedAt      DateTime?
  finalizedAt       DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  employee          Employee          @relation(fields: [employeeId], references: [id])
  leavePeriod       LeavePeriod       @relation(fields: [leavePeriodId], references: [id])
  leaveTypeConfig   LeaveTypeConfig   @relation(fields: [leaveTypeConfigId], references: [id])
  approvals         LeaveApproval[]
  
  @@map("leave_requests")
}

model LeaveApproval {
  id            BigInt         @id @default(autoincrement())
  leaveRequestId BigInt
  approverId    BigInt
  approverType  String         // 'MANAGER' | 'HR'
  status        ApprovalStatus @default(PENDING)
  comments      String?
  approvedAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  leaveRequest  LeaveRequest   @relation(fields: [leaveRequestId], references: [id])
  approver      Employee       @relation("LeaveApprovals", fields: [approverId], references: [id])
  
  @@unique([leaveRequestId, approverId, approverType])
  @@map("leave_approvals")
}

model Salary {
  id          BigInt    @id @default(autoincrement())
  employeeId  BigInt
  baseSalary  Decimal
  allowances  Decimal   @default(0)
  grade       String?
  effectiveDate DateTime @db.Date
  endDate     DateTime? @db.Date
  isActive    Boolean   @default(true)
  notes       String?
  createdBy   BigInt
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  employee    Employee  @relation(fields: [employeeId], references: [id])
  
  @@map("salaries")
}

model SalaryHistory {
  id            BigInt    @id @default(autoincrement())
  employeeId    BigInt
  changeType    SalaryChangeType
  oldBaseSalary Decimal?
  newBaseSalary Decimal
  oldGrade      String?
  newGrade      String?
  oldPosition   String?
  newPosition   String?
  oldDepartment String?
  newDepartment String?
  reason        String
  effectiveDate DateTime  @db.Date
  approvedBy    BigInt?
  createdAt     DateTime  @default(now())
  
  employee      Employee  @relation(fields: [employeeId], references: [id])
  
  @@map("salary_histories")
}

model OvertimeRequest {
  id                BigInt              @id @default(autoincrement())
  employeeId        BigInt
  attendanceId      BigInt?
  date              DateTime            @db.Date
  startTime         DateTime
  endTime           DateTime
  totalMinutes      Int
  reason            String
  status            OvertimeStatus      @default(PENDING)
  overtimeRate      Decimal?
  calculatedAmount  Decimal?
  managerComments   String?
  hrComments        String?
  rejectionReason   String?
  submittedAt       DateTime            @default(now())
  managerApprovedAt DateTime?
  hrApprovedAt      DateTime?
  finalizedAt       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  employee          Employee            @relation(fields: [employeeId], references: [id])
  attendance        Attendance?         @relation(fields: [attendanceId], references: [id])
  approvals         OvertimeApproval[]
  
  @@map("overtime_requests")
}

model OvertimeApproval {
  id               BigInt         @id @default(autoincrement())
  overtimeRequestId BigInt
  approverId       BigInt
  approverType     String         // 'MANAGER' | 'HR'
  status           ApprovalStatus @default(PENDING)
  comments         String?
  approvedAt       DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  
  overtimeRequest  OvertimeRequest @relation(fields: [overtimeRequestId], references: [id])
  approver         Employee        @relation("OvertimeApprovals", fields: [approverId], references: [id])
  
  @@unique([overtimeRequestId, approverId, approverType])
  @@map("overtime_approvals")
}
